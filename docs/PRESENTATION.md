# CamAI — Интеллектуальная система видеонаблюдения

## Что такое CamAI?

CamAI — это программный продукт, который превращает обычные камеры видеонаблюдения в интеллектуальную систему аналитики. Система анализирует видеопоток с помощью ИИ (Google Gemini) и автоматически обнаруживает инциденты, подсчитывает посетителей, выявляет подозрительное поведение и отправляет уведомления в Telegram.

**Установка за 5 минут. Работает на любом мини-сервере. Не требует облака.**

---

## Для кого

| Сегмент | Что решает CamAI |
|---------|-----------------|
| Супермаркеты и магазины | Подсчёт посетителей, контроль очередей, обнаружение краж |
| Рестораны и кафе | Заполненность залов, контроль обслуживания, гигиена |
| Склады и логистика | Безопасность (каски, жилеты), контроль зон, отслеживание грузов |
| Офисы | Учёт посещений, контроль заполняемости, безопасность |
| Банки | Распознавание подозрительных лиц, контроль очередей |
| Паркинги | Подсчёт мест, контроль потока транспорта |

---

## Ключевые возможности

### 1. ИИ-анализ видеопотока

Система захватывает кадры с камер и отправляет на анализ Google Gemini. ИИ понимает контекст сцены и выявляет:

- **Движение и вторжение** — обнаружение в запретных зонах
- **Подсчёт людей** — сколько человек в кадре, вход/выход
- **Очереди** — длина очереди, время ожидания
- **Подозрительное поведение** — слоняющиеся лица, оставленные предметы
- **Толпы** — превышение допустимого количества людей
- **Безопасность** — отсутствие СИЗ, опасные ситуации

Каждое событие имеет уровень серьёзности: `info`, `warning`, `critical`.

### 2. Поиск людей по фото

Загрузите фотографию человека — система извлечёт дескриптор лица (128-мерный вектор) и будет искать совпадения на всех камерах в реальном времени.

- Загрузка фото → автоматическое извлечение лица
- Поиск по всем камерам одновременно
- Таймлайн появлений с указанием камеры, времени и точности совпадения
- Включение/отключение активного поиска

**Применение:** розыск подозрительных лиц, VIP-клиенты, контроль доступа.

### 3. Умные функции на каждую камеру

Для каждой камеры можно включить специализированные ИИ-функции:

| Функция | Описание |
|---------|----------|
| Контроль очередей | Подсчёт людей в очереди, алерт при превышении |
| Поиск лиц | Распознавание и сравнение лиц в реальном времени |
| Обнаружение слоняющихся | Люди, долго стоящие без дела — сигнал охране |
| Мониторинг рабочих мест | Алерт если рабочее место пустует |

### 4. Мгновенные уведомления в Telegram

При обнаружении инцидента система отправляет уведомление прямо в Telegram бот:

- Подключение бота за 3 шага (создать бота → указать токен → привязать чат)
- Настройка уведомлений по филиалам (только критические / все)
- Описание инцидента + камера + время

### 5. Интеграции

| Канал | Тип |
|-------|-----|
| Telegram | Бот с прямыми уведомлениями |
| Slack | Вебхуки |
| Email | SMTP |
| SMS | Через API провайдера |
| Webhook | Любой HTTP endpoint |
| REST API | Произвольная интеграция |
| MQTT | IoT брокеры |
| Modbus | Промышленное оборудование |
| 1C, Bitrix, iiko, СКУД | Бизнес-системы |

### 6. Аналитика и отчёты

Панель аналитики с фильтрами по периоду, камере, типу события:

- **Карточки KPI:** всего событий, обнаружено людей, сессий анализа, обработано кадров
- **График активности по часам** — когда наибольшая нагрузка
- **Разбивка по типам событий** — движение, лица, очереди, вторжения
- **Разбивка по серьёзности** — critical / warning / info
- **Экспорт** в CSV и JSON для дальнейшей обработки

### 7. Мультифилиальность

Архитектура для компаний с несколькими точками:

```
Клиент → romashka.camvision.com → Центральный сервер
                                       ↑ push каждые 5 мин
                            Спутник 1 ──┘  (Филиал Алмазар)
                            Спутник 2 ──┘  (Филиал Чиланзар)
                            Спутник 3 ──┘  (Филиал Юнусабад)
```

**Как работает:**
- Каждый филиал имеет свой мини-сервер (спутник), который работает автономно
- Спутники отправляют данные (камеры + события) на центральный сервер каждые 5 минут
- На центральном сервере клиент видит **все филиалы** с одного URL
- Если интернет пропал — спутник копит данные в очередь и отправит при восстановлении

**Что видит клиент на центральном:**
- Единый дашборд с суммарной статистикой всех филиалов
- Список филиалов с индикаторами online/offline
- Объединённая лента событий со всех точек
- Фильтрация по конкретному филиалу

### 8. Удалённый доступ через Cloudflare Tunnel

Доступ к системе из интернета без статического IP и без открытия портов:

- Cloudflare Tunnel создаёт защищённое соединение с сервера к Cloudflare
- Клиент заходит по красивому домену: `romashka.camvision.com`
- SSL/TLS шифрование из коробки
- Не нужен белый IP, не нужен проброс портов

---

## Автоматическое обнаружение камер

При добавлении камер система автоматически сканирует локальную сеть и находит:

- RTSP камеры (Hikvision, Dahua, Trassir)
- HTTP/IP камеры
- IP Webcam на телефонах Android

Достаточно нажать «Найти камеры» — система предложит список обнаруженных устройств.

---

## Установка за 5 минут

Одна команда устанавливает всё:

```bash
bash install-client.sh \
  --key "Gemini_API_ключ" \
  --company "Магазин Ромашка" \
  --telegram "токен_бота"
```

Скрипт автоматически:
1. Устанавливает Docker (если нет)
2. Скачивает Docker-образ CamAI
3. Настраивает базу данных
4. Создаёт админ-аккаунт
5. Настраивает автообновления (Watchtower, каждые 24ч)
6. Настраивает ежедневный бэкап в 3:00
7. Запускает систему

**Для мультифилиальной установки:**

```bash
# Центральный сервер
bash install-client.sh \
  --key "ключ" --company "Ромашка" --telegram "токен" \
  --central --sync-key "секретный_ключ" \
  --tunnel "токен_tunnel" --domain "romashka.camvision.com"

# Филиал-спутник
bash install-client.sh \
  --key "ключ" --company "Ромашка Алмазар" --telegram "токен" \
  --sync-to "https://romashka.camvision.com" --sync-key "секретный_ключ"
```

---

## Требования к оборудованию

### Мини-сервер (на каждый филиал)

| Параметр | Минимум | Рекомендуется |
|----------|---------|---------------|
| CPU | 2 ядра | 4 ядра |
| RAM | 2 ГБ | 4 ГБ |
| Диск | 32 ГБ SSD | 64 ГБ SSD |
| ОС | Ubuntu 20.04+ / Debian 11+ | Ubuntu 22.04 LTS |
| Сеть | Ethernet (та же сеть что и камеры) | Gigabit Ethernet |

Подходят: мини-ПК (Intel NUC, Beelink), старый ноутбук, одноплатный компьютер (Orange Pi 5).

### Камеры

Поддерживаются любые IP-камеры с RTSP потоком:
- Hikvision
- Dahua
- Trassir
- Uniview
- Любые ONVIF-совместимые
- IP Webcam (Android)

---

## Безопасность

| Аспект | Реализация |
|--------|------------|
| Аутентификация | Парольная (bcrypt хеширование) + сессии JWT |
| Данные | Хранятся только локально (SQLite), не уходят в облако |
| Сеть | Cloudflare Tunnel (шифрованный канал), HTTPS |
| Docker | Запуск от непривилегированного пользователя |
| Бэкап | Ежедневный в 3:00 через cron |
| Sync | Аутентификация по общему ключу (X-Sync-Key) |
| .env | Права доступа 600 (только root) |

---

## Стоимость владения

| Компонент | Стоимость |
|-----------|-----------|
| Мини-сервер | Единоразово (клиент покупает сам) |
| CamAI ПО | Лицензия / подписка |
| Google Gemini API | Бесплатно: 15 запросов/мин, 1500/день. Платный: от $0.075/1000 запросов |
| Cloudflare Tunnel | Бесплатно |
| Docker / GitHub | Бесплатно |
| Telegram уведомления | Бесплатно |
| Домен (опционально) | ~$10/год |

**Ежемесячные расходы на инфраструктуру: $0** (при использовании бесплатного тарифа Gemini).

---

## Мобильный доступ (PWA)

CamAI — прогрессивное веб-приложение. Можно установить на телефон как приложение:

- Откройте сайт в браузере → «Добавить на главный экран»
- Работает как нативное приложение (полный экран, иконка)
- Адаптивный дизайн для любого размера экрана
- Работает на iOS и Android

---

## Технологический стек

| Слой | Технология |
|------|-----------|
| Фронтенд | Next.js 16, React 19, TypeScript, Tailwind CSS 4 |
| Бэкенд | Node.js, Next.js API Routes |
| База данных | SQLite (Prisma ORM) |
| ИИ | Google Gemini API |
| Лица | TensorFlow.js, face-api.js |
| Контейнеризация | Docker, Docker Compose |
| Прокси | Nginx + Let's Encrypt |
| Туннель | Cloudflare Tunnel (cloudflared) |
| Обновления | Watchtower (автоматически каждые 24ч) |

---

## Пример сценария использования

### Сеть магазинов «Ромашка» (3 филиала)

**Проблема:** Владелец не может контролировать все 3 точки одновременно. Камеры есть, но никто не смотрит записи. Кражи, очереди, простои кассиров — узнаёт постфактум.

**Решение с CamAI:**

1. На каждый филиал устанавливается мини-сервер с CamAI
2. Центральный сервер с Cloudflare Tunnel на `romashka.camvision.com`
3. Камеры на входе, кассах, складе подключаются автоматически

**Результат:**
- Владелец открывает `romashka.camvision.com` с телефона
- Видит дашборд: 12 камер, 10 онлайн, 47 событий за сегодня, 2 критических
- Получает Telegram: «Склад (Алмазар) — обнаружено проникновение, 14:32»
- В аналитике видит: пик посетителей 12:00–14:00, очередь > 5 человек 23 раза за неделю
- Находит подозрительного по фото: «был на камере Вход (Чиланзар) в 11:47, точность 94%»

---

## Обновления

Система обновляется автоматически:
- При каждом push в GitHub собирается новый Docker-образ
- Watchtower на серверах клиентов проверяет обновления каждые 24 часа
- При наличии нового образа — автоматически обновляет контейнер
- Без простоя, без участия клиента

---

## API для разработчиков

CamAI предоставляет REST API для интеграции с внешними системами:

```
GET  /api/dashboard/stats     — Сводная статистика
GET  /api/events              — Лента событий (фильтры, пагинация)
GET  /api/events/stream       — Реальное время (SSE)
GET  /api/cameras             — Список камер
GET  /api/branches            — Список филиалов
GET  /api/analytics           — Аналитика за период
GET  /api/analytics/export    — Экспорт (CSV/JSON)
POST /api/sync/push           — Приём данных от спутников
GET  /api/sync/status         — Статус синхронизации
GET  /api/health              — Health check
```

Все эндпоинты защищены авторизацией (JWT сессия).

---

## Контакты

- **GitHub:** github.com/asilbektilavov/cam-ai
- **Docker:** ghcr.io/asilbektilavov/cam-ai:latest
