services:
  db:
    image: postgres:16-alpine
    container_name: camai-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: camai
      POSTGRES_USER: camai
      POSTGRES_PASSWORD: ${DB_PASSWORD:-camai_secret_2024}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U camai"]
      interval: 10s
      timeout: 5s
      retries: 5

  cam-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: camai-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "3000:3000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - DATABASE_URL=postgresql://camai:${DB_PASSWORD:-camai_secret_2024}@db:5432/camai
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-change-me-to-random-string}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-http://localhost:3000}
      - NEXTAUTH_TRUST_HOST=true
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - YOLO_SERVICE_URL=http://detector:8001
      - ATTENDANCE_SERVICE_URL=http://attendance:8002
      - PLATE_SERVICE_URL=http://plate:8003
      # go2rtc runs on host network — reach it via host gateway
      - GO2RTC_URL=http://host.docker.internal:1984
    volumes:
      - cam-ai-data:/app/data
      - uploads:/app/public/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  detector:
    build: ./detection-service
    container_name: camai-detector
    restart: unless-stopped
    expose:
      - "8001"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - YOLO_CONFIDENCE=0.65
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8001/health')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # attendance/plate need LAN access for RTSP cameras — use host network
  attendance:
    build: ./attendance-service
    container_name: camai-attendance
    restart: unless-stopped
    depends_on:
      cam-ai:
        condition: service_healthy
    network_mode: host
    environment:
      - CAM_AI_API_URL=http://127.0.0.1:3000
      - ATTENDANCE_API_KEY=${ATTENDANCE_API_KEY:-}
      - POLL_INTERVAL=0.5
      - MATCH_TOLERANCE=0.45
      - COOLDOWN_SECONDS=300

  plate:
    build: ./plate-service
    container_name: camai-plate
    restart: unless-stopped
    depends_on:
      cam-ai:
        condition: service_healthy
    network_mode: host
    environment:
      - CAM_AI_API_URL=http://127.0.0.1:3000
      - PLATE_API_KEY=${PLATE_API_KEY:-}
      - POLL_INTERVAL=1.0
      - COOLDOWN_SECONDS=120

  go2rtc:
    image: alexxit/go2rtc:latest
    container_name: camai-go2rtc
    restart: unless-stopped
    network_mode: host
    environment:
      - GO2RTC_API_LISTEN=:1984
      - GO2RTC_WEBRTC_LISTEN=:8555
      - GO2RTC_RTSP_LISTEN=:8554
    volumes:
      - go2rtc-data:/config

  nginx:
    image: nginx:alpine
    container_name: camai-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      cam-ai:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/health-nginx"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  pgdata:
    driver: local
  cam-ai-data:
    driver: local
  uploads:
    driver: local
  go2rtc-data:
    driver: local
