version: '3.8'

services:
  db:
    image: postgres:16-alpine
    container_name: camai-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: camai
      POSTGRES_USER: camai
      POSTGRES_PASSWORD: ${DB_PASSWORD:-camai_secret_2024}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U camai"]
      interval: 10s
      timeout: 5s
      retries: 5

  cam-ai:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cam-ai-app
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    expose:
      - "3000"
    environment:
      - DATABASE_URL=postgresql://camai:${DB_PASSWORD:-camai_secret_2024}@db:5432/camai
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET:-change-me-to-random-string}
      - NEXTAUTH_URL=${NEXTAUTH_URL:-https://example.com}
      - NEXTAUTH_TRUST_HOST=true
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - YOLO_SERVICE_URL=http://detector:8001
    volumes:
      - cam-ai-data:/app/data
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '2'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/health"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3

  detector:
    build: ./detection-service
    container_name: camai-detector
    restart: unless-stopped
    expose:
      - "8001"
    environment:
      - YOLO_CONFIDENCE=0.65
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8001/health')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  attendance:
    build: ./attendance-service
    container_name: camai-attendance
    restart: unless-stopped
    depends_on:
      cam-ai:
        condition: service_healthy
    expose:
      - "8002"
    environment:
      - CAM_AI_API_URL=http://cam-ai:3000
      - ATTENDANCE_API_KEY=${ATTENDANCE_API_KEY:-}
      - POLL_INTERVAL=0.5
      - MATCH_TOLERANCE=0.45
      - COOLDOWN_SECONDS=300
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8002/health')"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: cam-ai-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - certbot-webroot:/var/www/certbot:ro
      - certbot-certs:/etc/letsencrypt:ro
    depends_on:
      cam-ai:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health-nginx"]
      interval: 30s
      timeout: 5s
      retries: 3

  certbot:
    image: certbot/certbot
    container_name: cam-ai-certbot
    volumes:
      - certbot-webroot:/var/www/certbot
      - certbot-certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do sleep 12h & wait $${!}; certbot renew --webroot -w /var/www/certbot --quiet; done'"

volumes:
  pgdata:
    driver: local
  cam-ai-data:
    driver: local
  certbot-webroot:
    driver: local
  certbot-certs:
    driver: local
